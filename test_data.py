"""
ç”Ÿæˆæ¸¬è©¦è³‡æ–™å’ŒåŸ·è¡Œæ¸¬è©¦
"""

import csv
from datetime import datetime, timedelta
import os


def generate_sample_csv(output_path: str = "sample_attendance.csv"):
    """ç”Ÿæˆç¯„ä¾‹æ‰“å¡è³‡æ–™"""
    
    # ç¯„ä¾‹è³‡æ–™
    records = [
        # ç‹å°æ˜ - æ™®é€šå“¡å·¥ï¼ˆèµ·ç®—æ™‚é–“ 08:00ï¼‰
        ("ç‹å°æ˜", "001", "2024-01-15 08:30", "ç°½åˆ°"),
        ("ç‹å°æ˜", "001", "2024-01-15 12:00", "ç°½é€€"),
        ("ç‹å°æ˜", "001", "2024-01-15 13:00", "ç°½åˆ°"),
        ("ç‹å°æ˜", "001", "2024-01-15 17:30", "ç°½é€€"),
        
        # æå°è¯ - æ™®é€šå“¡å·¥
        ("æå°è¯", "002", "2024-01-15 08:15", "ç°½åˆ°"),
        ("æå°è¯", "002", "2024-01-15 12:30", "ç°½é€€"),
        ("æå°è¯", "002", "2024-01-15 13:30", "ç°½åˆ°"),
        ("æå°è¯", "002", "2024-01-15 18:00", "ç°½é€€"),
        
        # é™³å“ç’‡ - ç‰¹æ®Šç­åˆ¥ï¼ˆèµ·ç®—æ™‚é–“ 11:00ï¼‰
        ("é™³å“ç’‡", "101", "2024-01-15 11:15", "ç°½åˆ°"),
        ("é™³å“ç’‡", "101", "2024-01-15 14:30", "ç°½é€€"),
        ("é™³å“ç’‡", "101", "2024-01-15 15:00", "ç°½åˆ°"),
        ("é™³å“ç’‡", "101", "2024-01-15 20:00", "ç°½é€€"),
        
        # å¼µä¸‰è± - åŠ ç­å“¡å·¥
        ("å¼µä¸‰è±", "003", "2024-01-15 08:00", "ç°½åˆ°"),
        ("å¼µä¸‰è±", "003", "2024-01-15 12:00", "ç°½é€€"),
        ("å¼µä¸‰è±", "003", "2024-01-15 13:00", "ç°½åˆ°"),
        ("å¼µä¸‰è±", "003", "2024-01-15 20:30", "ç°½é€€"),
        
        # ç‹å°æ˜ - ç¬¬äºŒå¤©
        ("ç‹å°æ˜", "001", "2024-01-16 08:45", "ç°½åˆ°"),
        ("ç‹å°æ˜", "001", "2024-01-16 12:15", "ç°½é€€"),
        ("ç‹å°æ˜", "001", "2024-01-16 13:15", "ç°½åˆ°"),
        ("ç‹å°æ˜", "001", "2024-01-16 17:45", "ç°½é€€"),
        
        # æå°è¯ - ç¬¬äºŒå¤©
        ("æå°è¯", "002", "2024-01-16 08:30", "ç°½åˆ°"),
        ("æå°è¯", "002", "2024-01-16 12:45", "ç°½é€€"),
        ("æå°è¯", "002", "2024-01-16 13:45", "ç°½åˆ°"),
        ("æå°è¯", "002", "2024-01-16 18:15", "ç°½é€€"),
        
        # é™³å“ç’‡ - ç¬¬äºŒå¤©
        ("é™³å“ç’‡", "101", "2024-01-16 11:30", "ç°½åˆ°"),
        ("é™³å“ç’‡", "101", "2024-01-16 14:45", "ç°½é€€"),
        ("é™³å“ç’‡", "101", "2024-01-16 15:15", "ç°½åˆ°"),
        ("é™³å“ç’‡", "101", "2024-01-16 20:30", "ç°½é€€"),
    ]
    
    # å¯«å…¥ CSV
    with open(output_path, "w", newline="", encoding="utf-8") as f:
        writer = csv.writer(f)
        writer.writerow(["å§“å", "è€ƒå‹¤è™Ÿç¢¼", "æ—¥æœŸæ™‚é–“", "ç°½åˆ°/é€€"])
        writer.writerows(records)
    
    print(f"âœ… å·²ç”Ÿæˆç¯„ä¾‹è³‡æ–™ï¼š{output_path}")
    return output_path


def test_calculator():
    """æ¸¬è©¦è¨ˆç®—é‚è¼¯"""
    from attendance_calculator import AttendanceProcessor
    
    print("\n" + "="*60)
    print("æ¸¬è©¦å‡ºå‹¤è¨ˆç®—é‚è¼¯")
    print("="*60)
    
    # ç”Ÿæˆæ¸¬è©¦è³‡æ–™
    csv_path = generate_sample_csv()
    
    # å»ºç«‹è™•ç†å™¨
    processor = AttendanceProcessor(
        employee_start_times={
            "101": (11, 0),  # é™³å“ç’‡
        }
    )
    
    # è™•ç†è³‡æ–™
    try:
        result_df = processor.process_csv(csv_path)
        
        print("\nğŸ“Š è™•ç†çµæœï¼š")
        print(result_df.to_string())
        
        # é©—è­‰çµæœ
        print("\n" + "="*60)
        print("é©—è­‰è¨ˆç®—çµæœ")
        print("="*60)
        
        # æª¢æŸ¥ç‹å°æ˜ 2024-01-15
        wang_data = result_df[
            (result_df["å§“å"] == "ç‹å°æ˜") & 
            (result_df["æ—¥æœŸ"] == "2024/01/15")
        ]
        
        if not wang_data.empty:
            row = wang_data.iloc[0]
            print(f"\nâœ“ ç‹å°æ˜ (2024/01/15)ï¼š")
            print(f"  - ä¸Šç­æ™‚é–“ï¼š{row['ä¸Šç­æ™‚é–“']}")
            print(f"  - ä¸‹ç­æ™‚é–“ï¼š{row['ä¸‹ç­æ™‚é–“']}")
            print(f"  - ä¼‘æ¯æ™‚é–“ï¼š{row['ä¼‘æ¯é–‹å§‹']} ~ {row['ä¼‘æ¯çµæŸ']} ({row['ä¼‘æ¯åˆ†é˜æ•¸']} åˆ†é˜)")
            print(f"  - å¯¦éš›å·¥æ™‚ï¼š{row['å¯¦éš›å·¥æ™‚']} å°æ™‚")
            print(f"  - åŠ ç­æ™‚æ•¸ï¼š{row['åŠ ç­æ™‚æ•¸']} å°æ™‚")
            
            # é©—è­‰è¨ˆç®—
            # 08:30 ~ 12:00 = 3.5 å°æ™‚
            # 13:00 ~ 17:30 = 4.5 å°æ™‚
            # ä¸­é–“ä¼‘æ¯ 12:00 ~ 13:00 = 60 åˆ†é˜
            # ç¸½å·¥æ™‚ = (17:30 - 08:30) - 60 åˆ†é˜ = 9 å°æ™‚ - 1 å°æ™‚ = 8 å°æ™‚
            expected_hours = 8.0
            if abs(row['å¯¦éš›å·¥æ™‚'] - expected_hours) < 0.01:
                print(f"  âœ… å·¥æ™‚è¨ˆç®—æ­£ç¢º")
            else:
                print(f"  âš ï¸  å·¥æ™‚è¨ˆç®—å¯èƒ½æœ‰èª¤ï¼ˆæœŸæœ› {expected_hours}ï¼Œå¯¦éš› {row['å¯¦éš›å·¥æ™‚']}ï¼‰")
        
        # æª¢æŸ¥é™³å“ç’‡ 2024-01-15ï¼ˆç‰¹æ®Šç­åˆ¥ï¼‰
        chen_data = result_df[
            (result_df["å§“å"] == "é™³å“ç’‡") & 
            (result_df["æ—¥æœŸ"] == "2024/01/15")
        ]
        
        if not chen_data.empty:
            row = chen_data.iloc[0]
            print(f"\nâœ“ é™³å“ç’‡ (2024/01/15) - èµ·ç®—æ™‚é–“ 11:00ï¼š")
            print(f"  - ä¸Šç­æ™‚é–“ï¼š{row['ä¸Šç­æ™‚é–“']}")
            print(f"  - ä¸‹ç­æ™‚é–“ï¼š{row['ä¸‹ç­æ™‚é–“']}")
            print(f"  - ä¼‘æ¯æ™‚é–“ï¼š{row['ä¼‘æ¯é–‹å§‹']} ~ {row['ä¼‘æ¯çµæŸ']} ({row['ä¼‘æ¯åˆ†é˜æ•¸']} åˆ†é˜)")
            print(f"  - å¯¦éš›å·¥æ™‚ï¼š{row['å¯¦éš›å·¥æ™‚']} å°æ™‚")
            print(f"  - åŠ ç­æ™‚æ•¸ï¼š{row['åŠ ç­æ™‚æ•¸']} å°æ™‚")
            
            # é©—è­‰è¨ˆç®—
            # 11:15 ~ 14:30 = 3.25 å°æ™‚
            # 15:00 ~ 20:00 = 5 å°æ™‚
            # ä¸­é–“ä¼‘æ¯ 14:30 ~ 15:00 = 30 åˆ†é˜ -> è¨ˆç‚º 60 åˆ†é˜
            # ç¸½å·¥æ™‚ = (20:00 - 11:15) - 60 åˆ†é˜ = 8.75 å°æ™‚ - 1 å°æ™‚ = 7.75 å°æ™‚
            expected_hours = 7.75
            if abs(row['å¯¦éš›å·¥æ™‚'] - expected_hours) < 0.01:
                print(f"  âœ… å·¥æ™‚è¨ˆç®—æ­£ç¢º")
            else:
                print(f"  âš ï¸  å·¥æ™‚è¨ˆç®—å¯èƒ½æœ‰èª¤ï¼ˆæœŸæœ› {expected_hours}ï¼Œå¯¦éš› {row['å¯¦éš›å·¥æ™‚']}ï¼‰")
        
        # æª¢æŸ¥å¼µä¸‰è±ï¼ˆåŠ ç­ï¼‰
        zhang_data = result_df[
            (result_df["å§“å"] == "å¼µä¸‰è±") & 
            (result_df["æ—¥æœŸ"] == "2024/01/15")
        ]
        
        if not zhang_data.empty:
            row = zhang_data.iloc[0]
            print(f"\nâœ“ å¼µä¸‰è± (2024/01/15) - åŠ ç­å“¡å·¥ï¼š")
            print(f"  - ä¸Šç­æ™‚é–“ï¼š{row['ä¸Šç­æ™‚é–“']}")
            print(f"  - ä¸‹ç­æ™‚é–“ï¼š{row['ä¸‹ç­æ™‚é–“']}")
            print(f"  - ä¼‘æ¯æ™‚é–“ï¼š{row['ä¼‘æ¯é–‹å§‹']} ~ {row['ä¼‘æ¯çµæŸ']} ({row['ä¼‘æ¯åˆ†é˜æ•¸']} åˆ†é˜)")
            print(f"  - å¯¦éš›å·¥æ™‚ï¼š{row['å¯¦éš›å·¥æ™‚']} å°æ™‚")
            print(f"  - åŠ ç­æ™‚æ•¸ï¼š{row['åŠ ç­æ™‚æ•¸']} å°æ™‚")
            
            if row['åŠ ç­æ™‚æ•¸'] > 0:
                print(f"  âœ… åŠ ç­æ™‚æ•¸è¨ˆç®—æ­£ç¢º")
            else:
                print(f"  âš ï¸  åŠ ç­æ™‚æ•¸è¨ˆç®—å¯èƒ½æœ‰èª¤")
        
        # åŒ¯å‡º Excel
        excel_path = "sample_output.xlsx"
        processor.export_to_excel(result_df, excel_path)
        print(f"\nâœ… å·²åŒ¯å‡º Excelï¼š{excel_path}")
        
        print("\n" + "="*60)
        print("âœ… æ‰€æœ‰æ¸¬è©¦å®Œæˆ")
        print("="*60)
        
    except Exception as e:
        print(f"âŒ æ¸¬è©¦å¤±æ•—ï¼š{str(e)}")
        import traceback
        traceback.print_exc()


if __name__ == "__main__":
    test_calculator()
